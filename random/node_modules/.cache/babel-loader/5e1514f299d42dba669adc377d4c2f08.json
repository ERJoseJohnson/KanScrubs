{"ast":null,"code":"'use strict';\n\nvar fs = require('fs');\n\nvar os = require('os');\n\nvar path = require('path');\n\nvar util = require('util');\n\nvar zlib = require('zlib');\n\nvar hash = require('object-hash');\n\nvar MESSAGE = require('triple-beam').MESSAGE;\n\nvar PassThrough = require('stream').PassThrough;\n\nvar Transport = require('winston-transport');\n\nvar loggerDefaults = {\n  json: false,\n  colorize: false,\n  eol: os.EOL,\n  logstash: null,\n  prettyPrint: false,\n  label: null,\n  stringify: false,\n  depth: null,\n  showLevel: true,\n  timestamp: function () {\n    return new Date().toISOString();\n  }\n};\n\nvar DailyRotateFile = function (options) {\n  options = options || {};\n  Transport.call(this, options);\n\n  function throwIf(target\n  /* , illegal... */\n  ) {\n    Array.prototype.slice.call(arguments, 1).forEach(function (name) {\n      if (options[name]) {\n        throw new Error('Cannot set ' + name + ' and ' + target + ' together');\n      }\n    });\n  }\n\n  function getMaxSize(size) {\n    if (size && typeof size === 'string') {\n      var _s = size.toLowerCase().match(/^((?:0\\.)?\\d+)([k|m|g])$/);\n\n      if (_s) {\n        return size;\n      }\n    } else if (size && Number.isInteger(size)) {\n      var sizeK = Math.round(size / 1024);\n      return sizeK === 0 ? '1k' : sizeK + 'k';\n    }\n\n    return null;\n  }\n\n  function isValidFileName(filename) {\n    // eslint-disable-next-line no-control-regex\n    return !/[\"<>|:*?\\\\/\\x00\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x10\\x11\\x12\\x13\\x14\\x15\\x16\\x17\\x18\\x19\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f]/g.test(filename);\n  }\n\n  function isValidDirName(dirname) {\n    // eslint-disable-next-line no-control-regex\n    return !/[\"<>|\\x00\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x10\\x11\\x12\\x13\\x14\\x15\\x16\\x17\\x18\\x19\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f]/g.test(dirname);\n  }\n\n  this.options = Object.assign({}, loggerDefaults, options);\n\n  if (options.stream) {\n    throwIf('stream', 'filename', 'maxsize');\n    this.logStream = new PassThrough();\n    this.logStream.pipe(options.stream);\n  } else {\n    this.filename = options.filename ? path.basename(options.filename) : 'winston.log';\n    this.dirname = options.dirname || path.dirname(options.filename);\n\n    if (!isValidFileName(this.filename) || !isValidDirName(this.dirname)) {\n      throw new Error('Your path or filename contain an invalid character.');\n    }\n\n    var self = this;\n    this.logStream = require('file-stream-rotator').getStream({\n      filename: path.join(this.dirname, this.filename),\n      frequency: options.frequency ? options.frequency : 'custom',\n      date_format: options.datePattern ? options.datePattern : 'YYYY-MM-DD',\n      verbose: false,\n      size: getMaxSize(options.maxSize),\n      max_logs: options.maxFiles,\n      end_stream: true,\n      audit_file: options.auditFile ? options.auditFile : path.join(self.dirname, '.' + hash(options) + '-audit.json'),\n      file_options: options.options ? options.options : {\n        flags: 'a'\n      },\n      utc: options.utc ? options.utc : false,\n      extension: options.extension ? options.extension : '',\n      create_symlink: options.createSymlink ? options.createSymlink : false,\n      symlink_name: options.symlinkName ? options.symlinkName : 'current.log'\n    });\n    this.logStream.on('new', function (newFile) {\n      self.emit('new', newFile);\n    });\n    this.logStream.on('rotate', function (oldFile, newFile) {\n      self.emit('rotate', oldFile, newFile);\n    });\n    this.logStream.on('logRemoved', function (params) {\n      if (options.zippedArchive) {\n        var gzName = params.name + '.gz';\n\n        if (fs.existsSync(gzName)) {\n          fs.unlinkSync(gzName);\n          self.emit('logRemoved', gzName);\n          return;\n        }\n      }\n\n      self.emit('logRemoved', params.name);\n    });\n\n    if (options.zippedArchive) {\n      this.logStream.on('rotate', function (oldFile) {\n        var oldFileExist = fs.existsSync(oldFile);\n        var gzExist = fs.existsSync(oldFile + '.gz');\n\n        if (!oldFileExist || gzExist) {\n          return;\n        }\n\n        var gzip = zlib.createGzip();\n        var inp = fs.createReadStream(oldFile);\n        var out = fs.createWriteStream(oldFile + '.gz');\n        inp.pipe(gzip).pipe(out).on('finish', function () {\n          if (fs.existsSync(oldFile)) {\n            fs.unlinkSync(oldFile);\n          }\n\n          self.emit('archive', oldFile + '.gz');\n        });\n      });\n    }\n  }\n};\n\nmodule.exports = DailyRotateFile;\nutil.inherits(DailyRotateFile, Transport);\nDailyRotateFile.prototype.name = 'dailyRotateFile';\n\nvar noop = function () {};\n\nDailyRotateFile.prototype.log = function (info, callback) {\n  callback = callback || noop;\n  this.logStream.write(info[MESSAGE] + this.options.eol);\n  this.emit('logged', info);\n  callback(null, true);\n};\n\nDailyRotateFile.prototype.close = function () {\n  var self = this;\n\n  if (this.logStream) {\n    this.logStream.end(function () {\n      self.emit('finish');\n    });\n  }\n};\n\nDailyRotateFile.prototype.query = function (options, callback) {\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  if (!this.options.json) {\n    throw new Error('query() may not be used without the json option being set to true');\n  }\n\n  if (!this.filename) {\n    throw new Error('query() may not be used when initializing with a stream');\n  }\n\n  var self = this;\n  var results = [];\n  options = options || {}; // limit\n\n  options.rows = options.rows || options.limit || 10; // starting row offset\n\n  options.start = options.start || 0; // now\n\n  options.until = options.until || new Date();\n\n  if (typeof options.until !== 'object') {\n    options.until = new Date(options.until);\n  } // now - 24\n\n\n  options.from = options.from || options.until - 24 * 60 * 60 * 1000;\n\n  if (typeof options.from !== 'object') {\n    options.from = new Date(options.from);\n  } // 'asc' or 'desc'\n\n\n  options.order = options.order || 'desc';\n\n  var logFiles = function () {\n    var fileRegex = new RegExp(self.filename.replace('%DATE%', '.*'), 'i');\n    return fs.readdirSync(self.dirname).filter(function (file) {\n      return path.basename(file).match(fileRegex);\n    });\n  }();\n\n  if (logFiles.length === 0 && callback) {\n    callback(null, results);\n  }\n\n  (function processLogFile(file) {\n    if (!file) {\n      return;\n    }\n\n    var logFile = path.join(self.dirname, file);\n    var buff = '';\n    var stream;\n\n    if (file.endsWith('.gz')) {\n      stream = new PassThrough();\n      fs.createReadStream(logFile).pipe(zlib.createGunzip()).pipe(stream);\n    } else {\n      stream = fs.createReadStream(logFile, {\n        encoding: 'utf8'\n      });\n    }\n\n    stream.on('error', function (err) {\n      if (stream.readable) {\n        stream.destroy();\n      }\n\n      if (!callback) {\n        return;\n      }\n\n      return err.code === 'ENOENT' ? callback(null, results) : callback(err);\n    });\n    stream.on('data', function (data) {\n      data = (buff + data).split(/\\n+/);\n      var l = data.length - 1;\n\n      for (var i = 0; i < l; i++) {\n        add(data[i]);\n      }\n\n      buff = data[l];\n    });\n    stream.on('end', function () {\n      if (buff) {\n        add(buff, true);\n      }\n\n      if (logFiles.length) {\n        processLogFile(logFiles.shift());\n      } else if (callback) {\n        results.sort(function (a, b) {\n          var d1 = new Date(a.timestamp).getTime();\n          var d2 = new Date(b.timestamp).getTime();\n          return d1 > d2 ? 1 : d1 < d2 ? -1 : 0;\n        });\n\n        if (options.order === 'desc') {\n          results = results.reverse();\n        }\n\n        var start = options.start || 0;\n        var limit = options.limit || results.length;\n        results = results.slice(start, start + limit);\n\n        if (options.fields) {\n          results = results.map(function (log) {\n            var obj = {};\n            options.fields.forEach(function (key) {\n              obj[key] = log[key];\n            });\n            return obj;\n          });\n        }\n\n        callback(null, results);\n      }\n    });\n\n    function add(buff, attempt) {\n      try {\n        var log = JSON.parse(buff);\n\n        if (!log || typeof log !== 'object') {\n          return;\n        }\n\n        var time = new Date(log.timestamp);\n\n        if (options.from && time < options.from || options.until && time > options.until) {\n          return;\n        }\n\n        results.push(log);\n      } catch (e) {\n        if (!attempt) {\n          stream.emit('error', e);\n        }\n      }\n    }\n  })(logFiles.shift());\n};","map":{"version":3,"sources":["C:/Users/Jose Johnson/Desktop/KanScrubs/random/node_modules/winston-daily-rotate-file/daily-rotate-file.js"],"names":["fs","require","os","path","util","zlib","hash","MESSAGE","PassThrough","Transport","loggerDefaults","json","colorize","eol","EOL","logstash","prettyPrint","label","stringify","depth","showLevel","timestamp","Date","toISOString","DailyRotateFile","options","call","throwIf","target","Array","prototype","slice","arguments","forEach","name","Error","getMaxSize","size","_s","toLowerCase","match","Number","isInteger","sizeK","Math","round","isValidFileName","filename","test","isValidDirName","dirname","Object","assign","stream","logStream","pipe","basename","self","getStream","join","frequency","date_format","datePattern","verbose","maxSize","max_logs","maxFiles","end_stream","audit_file","auditFile","file_options","flags","utc","extension","create_symlink","createSymlink","symlink_name","symlinkName","on","newFile","emit","oldFile","params","zippedArchive","gzName","existsSync","unlinkSync","oldFileExist","gzExist","gzip","createGzip","inp","createReadStream","out","createWriteStream","module","exports","inherits","noop","log","info","callback","write","close","end","query","results","rows","limit","start","until","from","order","logFiles","fileRegex","RegExp","replace","readdirSync","filter","file","length","processLogFile","logFile","buff","endsWith","createGunzip","encoding","err","readable","destroy","code","data","split","l","i","add","shift","sort","a","b","d1","getTime","d2","reverse","fields","map","obj","key","attempt","JSON","parse","time","push","e"],"mappings":"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","sourcesContent":["'use strict';\r\n\r\nvar fs = require('fs');\r\nvar os = require('os');\r\nvar path = require('path');\r\nvar util = require('util');\r\nvar zlib = require('zlib');\r\nvar hash = require('object-hash');\r\nvar MESSAGE = require('triple-beam').MESSAGE;\r\nvar PassThrough = require('stream').PassThrough;\r\nvar Transport = require('winston-transport');\r\n\r\nvar loggerDefaults = {\r\n    json: false,\r\n    colorize: false,\r\n    eol: os.EOL,\r\n    logstash: null,\r\n    prettyPrint: false,\r\n    label: null,\r\n    stringify: false,\r\n    depth: null,\r\n    showLevel: true,\r\n    timestamp: function () {\r\n        return new Date().toISOString();\r\n    }\r\n};\r\n\r\nvar DailyRotateFile = function (options) {\r\n    options = options || {};\r\n    Transport.call(this, options);\r\n\r\n    function throwIf(target /* , illegal... */) {\r\n        Array.prototype.slice.call(arguments, 1).forEach(function (name) {\r\n            if (options[name]) {\r\n                throw new Error('Cannot set ' + name + ' and ' + target + ' together');\r\n            }\r\n        });\r\n    }\r\n\r\n    function getMaxSize(size) {\r\n        if (size && typeof size === 'string') {\r\n            var _s = size.toLowerCase().match(/^((?:0\\.)?\\d+)([k|m|g])$/);\r\n            if (_s) {\r\n                return size;\r\n            }\r\n        } else if (size && Number.isInteger(size)) {\r\n            var sizeK = Math.round(size / 1024);\r\n            return sizeK === 0 ? '1k' : sizeK + 'k';\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    function isValidFileName(filename) {\r\n        // eslint-disable-next-line no-control-regex\r\n        return !/[\"<>|:*?\\\\/\\x00\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x10\\x11\\x12\\x13\\x14\\x15\\x16\\x17\\x18\\x19\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f]/g.test(filename);\r\n    }\r\n\r\n    function isValidDirName(dirname) {\r\n        // eslint-disable-next-line no-control-regex\r\n        return !/[\"<>|\\x00\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x10\\x11\\x12\\x13\\x14\\x15\\x16\\x17\\x18\\x19\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f]/g.test(dirname);\r\n    }\r\n\r\n    this.options = Object.assign({}, loggerDefaults, options);\r\n\r\n    if (options.stream) {\r\n        throwIf('stream', 'filename', 'maxsize');\r\n        this.logStream = new PassThrough();\r\n        this.logStream.pipe(options.stream);\r\n    } else {\r\n        this.filename = options.filename ? path.basename(options.filename) : 'winston.log';\r\n        this.dirname = options.dirname || path.dirname(options.filename);\r\n\r\n        if (!isValidFileName(this.filename) || !isValidDirName(this.dirname)) {\r\n            throw new Error('Your path or filename contain an invalid character.');\r\n        }\r\n\r\n        var self = this;\r\n\r\n        this.logStream = require('file-stream-rotator').getStream({\r\n            filename: path.join(this.dirname, this.filename),\r\n            frequency: options.frequency ? options.frequency : 'custom',\r\n            date_format: options.datePattern ? options.datePattern : 'YYYY-MM-DD',\r\n            verbose: false,\r\n            size: getMaxSize(options.maxSize),\r\n            max_logs: options.maxFiles,\r\n            end_stream: true,\r\n            audit_file: options.auditFile ? options.auditFile : path.join(self.dirname, '.' + hash(options) + '-audit.json'),\r\n            file_options: options.options ? options.options : {flags: 'a'},\r\n            utc: options.utc ? options.utc : false,\r\n            extension: options.extension ? options.extension : '',\r\n            create_symlink: options.createSymlink ? options.createSymlink : false,\r\n            symlink_name: options.symlinkName ? options.symlinkName : 'current.log'\r\n        });\r\n\r\n        this.logStream.on('new', function (newFile) {\r\n            self.emit('new', newFile);\r\n        });\r\n\r\n        this.logStream.on('rotate', function (oldFile, newFile) {\r\n            self.emit('rotate', oldFile, newFile);\r\n        });\r\n\r\n        this.logStream.on('logRemoved', function (params) {\r\n            if (options.zippedArchive) {\r\n                var gzName = params.name + '.gz';\r\n                if (fs.existsSync(gzName)) {\r\n                    fs.unlinkSync(gzName);\r\n                    self.emit('logRemoved', gzName);\r\n                    return;\r\n                }\r\n            }\r\n            self.emit('logRemoved', params.name);\r\n        });\r\n\r\n        if (options.zippedArchive) {\r\n            this.logStream.on('rotate', function (oldFile) {\r\n                var oldFileExist = fs.existsSync(oldFile);\r\n                var gzExist = fs.existsSync(oldFile + '.gz');\r\n                if (!oldFileExist || gzExist) {\r\n                    return;\r\n                }\r\n\r\n                var gzip = zlib.createGzip();\r\n                var inp = fs.createReadStream(oldFile);\r\n                var out = fs.createWriteStream(oldFile + '.gz');\r\n                inp.pipe(gzip).pipe(out).on('finish', function () {\r\n                    if (fs.existsSync(oldFile)) {\r\n                        fs.unlinkSync(oldFile);\r\n                    }\r\n                    self.emit('archive', oldFile + '.gz');\r\n                });\r\n            });\r\n        }\r\n    }\r\n};\r\n\r\nmodule.exports = DailyRotateFile;\r\n\r\nutil.inherits(DailyRotateFile, Transport);\r\n\r\nDailyRotateFile.prototype.name = 'dailyRotateFile';\r\n\r\nvar noop = function () {};\r\nDailyRotateFile.prototype.log = function (info, callback) {\r\n    callback = callback || noop;\r\n\r\n    this.logStream.write(info[MESSAGE] + this.options.eol);\r\n    this.emit('logged', info);\r\n    callback(null, true);\r\n};\r\n\r\nDailyRotateFile.prototype.close = function () {\r\n    var self = this;\r\n    if (this.logStream) {\r\n        this.logStream.end(function () {\r\n            self.emit('finish');\r\n        });\r\n    }\r\n};\r\n\r\nDailyRotateFile.prototype.query = function (options, callback) {\r\n    if (typeof options === 'function') {\r\n        callback = options;\r\n        options = {};\r\n    }\r\n\r\n    if (!this.options.json) {\r\n        throw new Error('query() may not be used without the json option being set to true');\r\n    }\r\n\r\n    if (!this.filename) {\r\n        throw new Error('query() may not be used when initializing with a stream');\r\n    }\r\n\r\n    var self = this;\r\n    var results = [];\r\n    options = options || {};\r\n\r\n    // limit\r\n    options.rows = options.rows || options.limit || 10;\r\n\r\n    // starting row offset\r\n    options.start = options.start || 0;\r\n\r\n    // now\r\n    options.until = options.until || new Date;\r\n    if (typeof options.until !== 'object') {\r\n        options.until = new Date(options.until);\r\n    }\r\n\r\n    // now - 24\r\n    options.from = options.from || (options.until - (24 * 60 * 60 * 1000));\r\n    if (typeof options.from !== 'object') {\r\n        options.from = new Date(options.from);\r\n    }\r\n\r\n    // 'asc' or 'desc'\r\n    options.order = options.order || 'desc';\r\n\r\n    var logFiles = (function () {\r\n        var fileRegex = new RegExp(self.filename.replace('%DATE%', '.*'), 'i');\r\n        return fs.readdirSync(self.dirname).filter(function (file) {\r\n            return path.basename(file).match(fileRegex);\r\n        });\r\n    })();\r\n\r\n    if (logFiles.length === 0 && callback) {\r\n        callback(null, results);\r\n    }\r\n\r\n    (function processLogFile(file) {\r\n        if (!file) {\r\n            return;\r\n        }\r\n\r\n        var logFile = path.join(self.dirname, file);\r\n        var buff = '';\r\n\r\n        var stream;\r\n\r\n        if (file.endsWith('.gz')) {\r\n            stream = new PassThrough();\r\n            fs.createReadStream(logFile).pipe(zlib.createGunzip()).pipe(stream);\r\n        } else {\r\n            stream = fs.createReadStream(logFile, {\r\n                encoding: 'utf8'\r\n            });\r\n        }\r\n\r\n        stream.on('error', function (err) {\r\n            if (stream.readable) {\r\n                stream.destroy();\r\n            }\r\n\r\n            if (!callback) {\r\n                return;\r\n            }\r\n\r\n            return err.code === 'ENOENT' ? callback(null, results) : callback(err);\r\n        });\r\n\r\n        stream.on('data', function (data) {\r\n            data = (buff + data).split(/\\n+/);\r\n            var l = data.length - 1;\r\n\r\n            for (var i = 0; i < l; i++) {\r\n                add(data[i]);\r\n            }\r\n\r\n            buff = data[l];\r\n        });\r\n\r\n        stream.on('end', function () {\r\n            if (buff) {\r\n                add(buff, true);\r\n            }\r\n\r\n            if (logFiles.length) {\r\n                processLogFile(logFiles.shift());\r\n            } else if (callback) {\r\n                results.sort(function (a, b) {\r\n                    var d1 = new Date(a.timestamp).getTime();\r\n                    var d2 = new Date(b.timestamp).getTime();\r\n\r\n                    return d1 > d2 ? 1 : d1 < d2 ? -1 : 0;\r\n                });\r\n\r\n                if (options.order === 'desc') {\r\n                    results = results.reverse();\r\n                }\r\n\r\n                var start = options.start || 0;\r\n                var limit = options.limit || results.length;\r\n\r\n                results = results.slice(start, start + limit);\r\n\r\n                if (options.fields) {\r\n                    results = results.map(function (log) {\r\n                        var obj = {};\r\n                        options.fields.forEach(function (key) {\r\n                            obj[key] = log[key];\r\n                        });\r\n                        return obj;\r\n                    });\r\n                }\r\n\r\n                callback(null, results);\r\n            }\r\n        });\r\n\r\n        function add(buff, attempt) {\r\n            try {\r\n                var log = JSON.parse(buff);\r\n                if (!log || typeof log !== 'object') {\r\n                    return;\r\n                }\r\n\r\n                var time = new Date(log.timestamp);\r\n                if ((options.from && time < options.from) || (options.until && time > options.until)) {\r\n                    return;\r\n                }\r\n\r\n                results.push(log);\r\n            } catch (e) {\r\n                if (!attempt) {\r\n                    stream.emit('error', e);\r\n                }\r\n            }\r\n        }\r\n    })(logFiles.shift());\r\n};\r\n"]},"metadata":{},"sourceType":"script"}